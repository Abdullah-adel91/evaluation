<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تقييم المكالمات الشهري</title>
<style>
body { direction: rtl; font-family: Arial; background: #f2f2f2; padding: 10px; }
.item { background: #fff; margin: 6px 0; padding: 8px; border-radius: 8px; }
button { margin: 3px; padding: 5px 12px; font-size: 15px; }
.result { font-weight: bold; font-size: 18px; margin-right: 8px; }
.hidden { display: none; }
.alert { color: red; text-align: center; margin: 10px; }
h3 { text-align: center; margin-bottom: 10px; }
select, input { font-size: 16px; padding: 4px; margin-bottom: 10px; width: 100%; }
</style>
</head>
<body>

<h3>تقييم المكالمات الشهري</h3>

<label>اختر الموظف:</label>
<select id="employeeSelect"></select>
<br>

<div id="itemsContainer"></div>

<div id="msg" class="alert hidden">⚠️ لازم تقييم كل البنود قبل حفظ التقييم</div>

<br>
<button onclick="saveEvaluation()">حفظ التقييم</button>
<button onclick="exportExcel()">استخراج تقرير Excel + رسم بياني جاهز</button>
<button onclick="resetMonth()">إعادة تعيين الشهر</button>

<script>
// البنود النهائيه
const evaluationItems = [
  "ترحيب بداية المكالمة وذكر الاسم",
  "طلب اسم المشترك وذكره مرة واحدة",
  "أخذ رقم الحساب",
  "مطابقة بيانات الحساب",
  "أخذ إذن المشترك قبل وضعه على الانتظار",
  "إدارة وقت المكالمة",
  "شكر المشترك على الانتظار",
  "نبرة صوت واضحة",
  "التسويق لتوثيق العداد",
  "توثيق المكالمة",
  "إنهاء صحيح للمكالمة",
  "هل إجراء المكالمة صحيح؟"
];

// الموظفين الشهرية
let employees = ["أحمد", "محمد", "سلمان", "علي", "عبدالله"];
const employeeSelect = document.getElementById("employeeSelect");
function loadEmployees() {
  employeeSelect.innerHTML = "";
  employees.forEach(e => {
    const option = document.createElement("option");
    option.value = e;
    option.textContent = e;
    employeeSelect.appendChild(option);
  });
}

// توليد البنود
const itemsContainer = document.getElementById("itemsContainer");
function loadItems() {
  itemsContainer.innerHTML = "";
  evaluationItems.forEach(text => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `${text}<br>
      <button onclick="set(this,'✔️')">✔️</button>
      <button onclick="set(this,'✖️')">✖️</button>
      <span class="result"></span>`;
    itemsContainer.appendChild(div);
  });
}

// ✔️ أو ✖️
function set(btn,val){
  btn.parentElement.querySelector('.result').innerText = val;
}

// تحقق من تعبئة البنود
function allChecked(){
  return [...document.querySelectorAll('.result')]
    .every(r => r.innerText !== '');
}

// حفظ التقييم مؤقت
let monthEvaluations = [];
function saveEvaluation() {
  if(!allChecked()) {
    document.getElementById('msg').classList.remove('hidden');
    return;
  }
  document.getElementById('msg').classList.add('hidden');
  const evaluation = { 
    employee: employeeSelect.value,
    date: new Date().toLocaleDateString(),
    results: [...document.querySelectorAll('.result')].map(r => r.innerText)
  };
  monthEvaluations.push(evaluation);
  alert("تم حفظ التقييم بنجاح!");
  resetItems();
}

// إعادة ضبط البنود
function resetItems(){
  document.querySelectorAll('.result').forEach(r => r.innerText='');
}

// إعادة تعيين الشهر
function resetMonth() {
  if(confirm("هل تريد مسح كل بيانات هذا الشهر وبدء شهر جديد؟")) {
    monthEvaluations = [];
    resetItems();
  }
}

// استخراج Excel مع رسم بياني جاهز بدون مكتبات خارجية
function exportExcel() {
  if(monthEvaluations.length===0){
    alert("لا توجد تقييمات ليتم تصديرها.");
    return;
  }

  let csvContent = "data:text/csv;charset=utf-8,";

  // التفاصيل
  csvContent += ["الموظف","التاريخ",...evaluationItems].join(",") + "\n";
  monthEvaluations.forEach(e=>{
    csvContent += [e.employee,e.date,...e.results].join(",") + "\n";
  });

  // الملخص
  const empMap = {};
  monthEvaluations.forEach(e=>{
    if(!empMap[e.employee]) empMap[e.employee]={calls:0,errors:0};
    empMap[e.employee].calls +=1;
    empMap[e.employee].errors += e.results.filter(r=>"✖️"===r).length;
  });
  csvContent += "\nالموظف,عدد المكالمات,عدد الأخطاء,نسبة الأخطاء\n";
  Object.keys(empMap).forEach(emp=>{
    const data = empMap[emp];
    csvContent += [emp,data.calls,data.errors,(data.errors/data.calls/evaluationItems.length*100).toFixed(2)+"%"].join(",") + "\n";
  });

  // أفضل 5 / أسوأ 5
  const sorted = Object.entries(empMap).sort((a,b)=>a[1].errors-b[1].errors);
  csvContent += "\nأفضل 5 / أسوأ 5,عدد الأخطاء\n";
  sorted.forEach(e=>{
    csvContent += [e[0],e[1].errors].join(",") + "\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `تقرير_الشهر_${new Date().getMonth()+1}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// تشغيل الصفحة
loadEmployees();
loadItems();
</script>

</body>
</html>
