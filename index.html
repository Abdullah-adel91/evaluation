<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª â€“ Excel Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ø£Ù„ÙˆØ§Ù† Ù…ØªØ¯Ø±Ø¬Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{direction:rtl;font-family:Arial;padding:10px;background:#f5f5f5}
.item{background:#fff;margin:6px 0;padding:10px;border-radius:8px}
button{margin:3px;padding:6px 12px;font-size:16px}
.result{font-size:18px;font-weight:bold;margin-right:8px}
select,input,textarea{padding:8px;font-size:16px;margin-top:5px}
textarea{width:100%;}
</style>
</head>
<body>

<h2 style="text-align:center">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</h2>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
<div>
  <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
  <select id="employeeSelect"></select>
  <button onclick="addEmployee()">Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…</button>
  <button onclick="deleteEmployee()">Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
  <button onclick="saveEmployees()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
  <br><br>
  <label>Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø§Ø³Ù…):</label>
  <textarea id="bulkEmployees" rows="5" placeholder="Ø¶Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§"></textarea><br>
  <button onclick="addMultipleEmployees()">Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
</div>

<hr>

<h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</h3>
<div id="criteria"></div>
<button onclick="saveEvaluation()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
<button onclick="resetView()">Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>

<hr>
<h3>ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø§Ø­ØªØ±Ø§ÙÙŠ</h3>
<button onclick="downloadExcel()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</button>

<script>
let employees = JSON.parse(localStorage.getItem("employees")) || ["Ù…Ø­Ù…Ø¯","Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡","Ø³Ø§Ø±Ø©"];
let evaluations = JSON.parse(localStorage.getItem("evaluations")) || [];
const criteriaList = [
"ØªØ±Ø­ÙŠØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ°ÙƒØ± Ø§Ù„Ø§Ø³Ù…",
"Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙˆØ°ÙƒØ±Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©",
"Ø£Ø®Ø° Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨",
"Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨",
"Ø£Ø®Ø° Ø¥Ø°Ù† Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù‚Ø¨Ù„ ÙˆØ¶Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
"Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ‚Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
"Ø´ÙƒØ± Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
"Ù†Ø¨Ø±Ø© ØµÙˆØª ÙˆØ§Ø¶Ø­Ø©",
"Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯",
"ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
"Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­",
"Ù‡Ù„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ØµØ­ÙŠØ­"
];

/* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ */
function renderCriteria(){
  const div=document.getElementById("criteria");
  div.innerHTML="";
  criteriaList.forEach(c=>{
    div.innerHTML+=`<div class="item">${c}<br>
      <button onclick="setMark(this,'âœ”ï¸')">âœ”ï¸</button>
      <button onclick="setMark(this,'âœ–ï¸')">âœ–ï¸</button>
      <span class="result"></span>
    </div>`;
  });
}
function setMark(btn,val){
  btn.parentElement.querySelector('.result').innerText=val;
}

/* Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø¹ ØªØ£ÙƒÙŠØ¯ */
function saveEvaluation(){
  const employee=document.getElementById("employeeSelect").value;
  if(!employee) return alert("Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
  const results=[...document.querySelectorAll('.result')];
  if(results.some(r=>!r.innerText)) return alert("Ù‚ÙŠÙ‘Ù… ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯");

  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ù…ÙˆØ¸Ù: " + employee + "ØŸ")) return;

  results.forEach((r,i)=>{
    evaluations.push({
      name:employee,
      date:new Date().toLocaleDateString('ar-SA'),
      criteria:criteriaList[i],
      score:r.innerText
    });
  });
  localStorage.setItem("evaluations",JSON.stringify(evaluations));
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ù…ÙˆØ¸Ù: " + employee + " âœ”ï¸");
}

/* Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† */
function resetView(){
  document.querySelectorAll('.result').forEach(r=>r.innerText='');
}

/* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
function loadEmployeeNames(){
  const sel=document.getElementById("employeeSelect");
  sel.innerHTML="";
  employees.forEach(e=>sel.innerHTML+=`<option>${e}</option>`);
}
function addEmployee(){
  const name=prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
  if(name){employees.push(name);loadEmployeeNames();}
}
function addMultipleEmployees(){
  const text=document.getElementById("bulkEmployees").value;
  if(!text) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡");
  const names=text.split(/\r?\n/).map(n=>n.trim()).filter(n=>n);
  employees.push(...names);
  employees=[...new Set(employees)]; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
  loadEmployeeNames();
  alert(names.length+" Ø£Ø³Ù…Ø§Ø¡ ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ âœ”ï¸");
}
function deleteEmployee(){
  const sel=document.getElementById("employeeSelect");
  const name=sel.value;
  if(!name) return alert("Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù Ù„Ù„Ø­Ø°Ù");
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "+name+"ØŸ")){
    employees=employees.filter(e=>e!==name);
    loadEmployeeNames();
    localStorage.setItem("employees",JSON.stringify(employees));
    alert(name+" ØªÙ… Ø­Ø°ÙÙ‡ âœ”ï¸");
  }
}
function saveEmployees(){
  localStorage.setItem("employees",JSON.stringify(employees));
  alert("ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† âœ”ï¸");
}

/* â–‘ ØªÙ†Ø²ÙŠÙ„ Excel Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø¹ Ø£Ù„ÙˆØ§Ù† Ù…ØªØ¯Ø±Ø¬Ø© â–‘ */
function downloadExcel(){
  if(evaluations.length===0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");

  const matrix={};
  employees.forEach(e=>matrix[e]={});
  criteriaList.forEach(c=>employees.forEach(e=>matrix[e][c]=0));
  evaluations.forEach(ev=>{
    if(ev.score==='âœ–ï¸') matrix[ev.name][ev.criteria]++;
  });

  // Ø§Ù„ØµÙØ­Ø© 1: Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ã— Ø§Ù„Ø¨Ù†ÙˆØ¯
  const sheet1=[["Ø§Ù„Ù…ÙˆØ¸Ù",...criteriaList]];
  employees.forEach(e=>{
    const row=[e];
    criteriaList.forEach(c=>row.push(matrix[e][c]));
    sheet1.push(row);
  });

  // Ø§Ù„ØµÙØ­Ø© 2: Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
  const stats=[["Ø§Ù„Ù…ÙˆØ¸Ù","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯","Ø§Ù„Ù†Ø³Ø¨Ø© %"]];
  employees.forEach(e=>{
    const errors=criteriaList.reduce((sum,c)=>sum+matrix[e][c],0);
    const total=criteriaList.length;
    const pct=((total-errors)/total*100).toFixed(2);
    stats.push([e,errors,total,pct]);
  });

  // Ø§Ù„ØµÙØ­Ø© 3: Ø£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ 5
  const sortedStats=[...stats].slice(1).sort((a,b)=>a[1]-b[1]);
  const top5=[["Ø£ÙØ¶Ù„ 5"],["Ø§Ù„Ù…ÙˆØ¸Ù","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"],...sortedStats.slice(0,5)];
  const bottom5=[["Ø£Ø³ÙˆØ£ 5"],["Ø§Ù„Ù…ÙˆØ¸Ù","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"],...sortedStats.slice(-5)];
  const sheet3=[...top5,[],...bottom5];

  // Ø§Ù„ØµÙØ­Ø© 4: Dashboard (Ø¬Ø¯ÙˆÙ„ Ø¬Ø§Ù‡Ø² Pie Chart)
  const totalPerCriteria=criteriaList.map(c=>employees.reduce((sum,e)=>sum+matrix[e][c],0));
  const sheet4=[["Ø§Ù„Ø¨Ù†Ø¯","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"]];
  criteriaList.forEach((c,i)=>sheet4.push([c,totalPerCriteria[i]]));

  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet(sheet1);
  const ws2=XLSX.utils.aoa_to_sheet(stats);
  const ws3=XLSX.utils.aoa_to_sheet(sheet3);
  const ws4=XLSX.utils.aoa_to_sheet(sheet4);

  // ØªÙ„ÙˆÙŠÙ† Ù…ØªØ¯Ø±Ø¬ Ø­Ø³Ø¨ Ø´Ø¯Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  function styleSheet(ws){
    const range=XLSX.utils.decode_range(ws['!ref']);
    for(let C=range.s.c; C<=range.e.c; ++C){
      const cellAddress=XLSX.utils.encode_cell({r:0,c:C});
      if(ws[cellAddress]) ws[cellAddress].s={font:{bold:true},fill:{fgColor:{rgb:"FFB0C4DE"}}};
    }
    for(let R=1; R<=range.e.r; R++){
      for(let C=0; C<=range.e.c; C++){
        const cellAddress=XLSX.utils.encode_cell({r:R,c:C});
        if(ws[cellAddress]){
          ws[cellAddress].s={fill:{fgColor:{rgb:R%2===0?"FFFFFFFF":"FFF0F8FF"}}};
          if(C>0 && typeof ws[cellAddress].v==='number'){
            let val=ws[cellAddress].v;
            if(val===0){
              ws[cellAddress].s.fill={fgColor:{rgb:"FFDAF7DC"}}; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
            } else if(val<=2){
              ws[cellAddress].s.fill={fgColor:{rgb:"FFFFF3AA"}}; // Ø£ØµÙØ± ÙØ§ØªØ­
            } else if(val<=4){
              ws[cellAddress].s.fill={fgColor:{rgb:"FFFFC87C"}}; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            } else {
              ws[cellAddress].s.fill={fgColor:{rgb:"FFFF6B6B"}}; // Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚
            }
          }
        }
      }
    }
  }

  [ws1,ws2,ws3,ws4].forEach(styleSheet);

  XLSX.utils.book_append_sheet(wb,ws1,"Ø§Ù„ØªÙ‚ÙŠÙŠÙ…");
  XLSX.utils.book_append_sheet(wb,ws2,"Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª");
  XLSX.utils.book_append_sheet(wb,ws3,"Ø£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ 5");
  XLSX.utils.book_append_sheet(wb,ws4,"Dashboard");

  XLSX.writeFile(wb,"ØªÙ‚ÙŠÙŠÙ…Ø§Øª_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.xlsx");
}

/* Ø§Ù„ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø© */
renderCriteria();
loadEmployeeNames();
</script>

</body>
</html>
