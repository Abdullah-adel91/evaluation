<!-- ... الجزء العلوي من كودك يبقى كما هو ... -->

<script>
/* ░░▒▒ بيانات أساسية ▒▒░░ */
let employees = JSON.parse(localStorage.getItem("employees")) || ["محمد","عبدالله","سارة"];
let evaluations = JSON.parse(localStorage.getItem("evaluations")) || [];
const criteriaList = [
"ترحيب بداية المكالمة وذكر الاسم",
"طلب اسم المشترك وذكره مرة واحدة",
"أخذ رقم الحساب",
"مطابقة بيانات الحساب",
"أخذ إذن المشترك قبل وضعه على الانتظار",
"إدارة وقت المكالمة",
"شكر المشترك على الانتظار",
"نبرة صوت واضحة",
"التسويق لتوثيق العداد",
"توثيق المكالمة",
"إغلاق المكالمة بشكل صحيح",
"هل إجراء المكالمة صحيح"
];

/* ░░▒▒ إنشاء البنود ▒▒░░ */
function renderCriteria(){
  const div = document.getElementById("criteria");
  div.innerHTML = "";
  criteriaList.forEach(c=>{
    div.innerHTML += `
    <div class="item">
      ${c}<br>
      <button onclick="setMark(this,'✔️')">✔️</button>
      <button onclick="setMark(this,'✖️')">✖️</button>
      <span class="result"></span>
    </div>`;
  });
}

function setMark(btn,val){
  btn.parentElement.querySelector('.result').innerText = val;
}

/* ░░▒▒ حفظ التقييم ▒▒░░ */
function saveEvaluation(){
  const employee = document.getElementById("employeeSelect").value;
  if(!employee) return alert("اختر اسم الموظف");

  const results = [...document.querySelectorAll('.result')];
  if(results.some(r=>!r.innerText)) return alert("قيّم كل البنود");

  results.forEach((r,i)=>{
    evaluations.push({
      name: employee,
      date: new Date().toLocaleDateString('ar-SA'),
      criteria: criteriaList[i],
      score: r.innerText,
      notes: r.innerText === "✖️" ? "وجود خطأ" : "لا يوجد"
    });
  });

  localStorage.setItem("evaluations",JSON.stringify(evaluations));
  alert("تم حفظ التقييم ✔️");
}

/* ░░▒▒ تحميل اكسل مع الإحصاءات وأفضل وأسوأ 5 ▒▒░░ */
function downloadExcel(){
  if(evaluations.length===0) return alert("مافي بيانات");

  // جدول التفاصيل الشهرية
  const details = [["اسم الموظف","التاريخ","البند","التقييم","ملاحظات"]];
  evaluations.forEach(e => details.push([e.name,e.date,e.criteria,e.score,e.notes]));

  // جدول الإحصاءات الشهرية
  const statsMap = {};
  evaluations.forEach(e=>{
    if(!statsMap[e.name]) statsMap[e.name] = {total:0, errors:0};
    statsMap[e.name].total++;
    if(e.score === "✖️") statsMap[e.name].errors++;
  });
  const stats = [["الموظف","عدد البنود","عدد الأخطاء","النسبة"]];
  for(let name in statsMap){
    const t = statsMap[name].total;
    const err = statsMap[name].errors;
    const pct = ((t-err)/t*100).toFixed(2) + "%";
    stats.push([name,t,err,pct]);
  }

  // أفضل وأسوأ 5 (حسب الأخطاء الأقل)
  const sorted = Object.entries(statsMap).sort((a,b)=>a[1].errors-b[1].errors);
  const top5 = sorted.slice(0,5).map(e=>[e[0],e[1].total - e[1].errors]);
  const bottom5 = sorted.slice(-5).map(e=>[e[0],e[1].total - e[1].errors]);
  const topBottom = [["أفضل 5"],["الموظف","النقاط"],...top5,[""],["أسوأ 5"],["الموظف","النقاط"],...bottom5];

  // إنشاء ملف Excel
  const wb = XLSX.utils.book_new();
  const wsDetails = XLSX.utils.aoa_to_sheet(details);
  const wsStats = XLSX.utils.aoa_to_sheet(stats);
  const wsTopBottom = XLSX.utils.aoa_to_sheet(topBottom);

  // Conditional formatting (تمييز الأخطاء باللون الأحمر)
  Object.keys(wsDetails).forEach(cell=>{
    if(cell[0]==='!') return;
    if(wsDetails[cell].v === "✖️"){
      wsDetails[cell].s = {fill: {fgColor: {rgb:"FFC7CE"}}};
    }
  });

  XLSX.utils.book_append_sheet(wb, wsDetails, "الشهر");
  XLSX.utils.book_append_sheet(wb, wsStats, "الإحصاءات الشهرية");
  XLSX.utils.book_append_sheet(wb, wsTopBottom, "أفضل وأسوأ 5");

  XLSX.writeFile(wb,"تقييمات_الشهر.xlsx",{compression:true});
}

/* ░░▒▒ باقي الدوال كما هي ▒▒░░ */
function showErrors(){document.querySelectorAll('.item').forEach(i=>i.style.display=i.querySelector('.result').innerText==='✖️'?'block':'none');}
function resetView(){document.querySelectorAll('.item').forEach(i=>{i.style.display='block';i.querySelector('.result').innerText='';});}
function deleteAllData(){if(confirm("هل انت متأكد من حذف كل بيانات هذا الشهر؟")){localStorage.removeItem("evaluations");evaluations=[];alert("تم حذف كل بيانات الشهر ✔️");}}
function loadEmployeeNames(){const sel=document.getElementById("employeeSelect");sel.innerHTML="";employees.forEach(e=>sel.innerHTML+=`<option>${e}</option>`);}
function addEmployee(){const name=prompt("اكتب اسم الموظف الجديد:");if(name){employees.push(name);loadEmployeeNames();}}
function saveEmployees(){localStorage.setItem("employees",JSON.stringify(employees));alert("تم حفظ قائمة الموظفين ✔️");}

/* ░░▒▒ تشغيل أول مرة ▒▒░░ */
renderCriteria();
loadEmployeeNames();

</script>
