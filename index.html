<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{direction:rtl;font-family:Arial;padding:10px;background:#f5f5f5}
.item{background:#fff;margin:6px 0;padding:10px;border-radius:8px}
button{margin:3px;padding:6px 12px;font-size:16px}
.result{font-size:18px;font-weight:bold;margin-right:8px}
select,input{padding:8px;font-size:16px;margin-top:5px}
</style>
</head>

<body>

<h2 style="text-align:center">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª</h2>

<div>
  <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label><br>
  <select id="employeeSelect"></select>
  <button onclick="addEmployee()">Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù…</button>
  <button onclick="saveEmployees()">Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
</div>

<hr>
<div id="criteria"></div>

<br>
<button onclick="saveEvaluation()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
<button onclick="showErrors()">Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙ‚Ø·</button>
<button onclick="resetView()">Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>

<hr>
<h3>Ø®ÙŠØ§Ø±Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</h3>
<button onclick="downloadExcel()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„</button>
<button onclick="deleteAllData()">âŒ Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>

<script>
/* Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
let employees = JSON.parse(localStorage.getItem("employees")) || ["Ù…Ø­Ù…Ø¯","Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡","Ø³Ø§Ø±Ø©"];
let evaluations = JSON.parse(localStorage.getItem("evaluations")) || [];
const criteriaList = [
"ØªØ±Ø­ÙŠØ¨ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ°ÙƒØ± Ø§Ù„Ø§Ø³Ù…",
"Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±Ùƒ ÙˆØ°ÙƒØ±Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©",
"Ø£Ø®Ø° Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨",
"Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨",
"Ø£Ø®Ø° Ø¥Ø°Ù† Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù‚Ø¨Ù„ ÙˆØ¶Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
"Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ‚Øª Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
"Ø´ÙƒØ± Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
"Ù†Ø¨Ø±Ø© ØµÙˆØª ÙˆØ§Ø¶Ø­Ø©",
"Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ø¯Ø§Ø¯",
"ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø©",
"Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­",
"Ù‡Ù„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© ØµØ­ÙŠØ­"
];

/* Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù†ÙˆØ¯ */
function renderCriteria(){
  const div = document.getElementById("criteria");
  div.innerHTML = "";
  criteriaList.forEach(c=>{
    div.innerHTML += `
    <div class="item">
      ${c}<br>
      <button onclick="setMark(this,'âœ”ï¸')">âœ”ï¸</button>
      <button onclick="setMark(this,'âœ–ï¸')">âœ–ï¸</button>
      <span class="result"></span>
    </div>`;
  });
}

function setMark(btn,val){
  btn.parentElement.querySelector('.result').innerText = val;
}

/* Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
function saveEvaluation(){
  const employee = document.getElementById("employeeSelect").value;
  if(!employee) return alert("Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
  const results = [...document.querySelectorAll('.result')];
  if(results.some(r=>!r.innerText)) return alert("Ù‚ÙŠÙ‘Ù… ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯");

  results.forEach((r,i)=>{
    evaluations.push({
      name: employee,
      date: new Date().toLocaleDateString('ar-SA'),
      criteria: criteriaList[i],
      score: r.innerText,
      notes: r.innerText === "âœ–ï¸" ? "ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
    });
  });

  localStorage.setItem("evaluations",JSON.stringify(evaluations));
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… âœ”ï¸");
}

/* ØªØ­Ù…ÙŠÙ„ Ø§ÙƒØ³Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª ÙˆØ£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ 5 */
function downloadExcel(){
  if(evaluations.length===0) return alert("Ù…Ø§ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª");

  const details = [["Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø¨Ù†Ø¯","Ø§Ù„ØªÙ‚ÙŠÙŠÙ…","Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]];
  evaluations.forEach(e => details.push([e.name,e.date,e.criteria,e.score,e.notes]));

  const statsMap = {};
  evaluations.forEach(e=>{
    if(!statsMap[e.name]) statsMap[e.name] = {total:0, errors:0};
    statsMap[e.name].total++;
    if(e.score === "âœ–ï¸") statsMap[e.name].errors++;
  });

  const stats = [["Ø§Ù„Ù…ÙˆØ¸Ù","Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯","Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡","Ø§Ù„Ù†Ø³Ø¨Ø©"]];
  for(let name in statsMap){
    const t = statsMap[name].total;
    const err = statsMap[name].errors;
    const pct = ((t-err)/t*100).toFixed(2) + "%";
    stats.push([name,t,err,pct]);
  }

  const sorted = Object.entries(statsMap).sort((a,b)=>a[1].errors-b[1].errors);
  const top5 = sorted.slice(0,5).map(e=>[e[0],e[1].total - e[1].errors]);
  const bottom5 = sorted.slice(-5).map(e=>[e[0],e[1].total - e[1].errors]);
  const topBottom = [["Ø£ÙØ¶Ù„ 5"],["Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ù†Ù‚Ø§Ø·"],...top5,[""],["Ø£Ø³ÙˆØ£ 5"],["Ø§Ù„Ù…ÙˆØ¸Ù","Ø§Ù„Ù†Ù‚Ø§Ø·"],...bottom5];

  const wb = XLSX.utils.book_new();
  const wsDetails = XLSX.utils.aoa_to_sheet(details);
  const wsStats = XLSX.utils.aoa_to_sheet(stats);
  const wsTopBottom = XLSX.utils.aoa_to_sheet(topBottom);

  // Conditional formatting (ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±)
  Object.keys(wsDetails).forEach(cell=>{
    if(cell[0]==='!') return;
    if(wsDetails[cell].v === "âœ–ï¸"){
      wsDetails[cell].s = {fill: {fgColor: {rgb:"FFC7CE"}}};
    }
  });

  XLSX.utils.book_append_sheet(wb, wsDetails, "Ø§Ù„Ø´Ù‡Ø±");
  XLSX.utils.book_append_sheet(wb, wsStats, "Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©");
  XLSX.utils.book_append_sheet(wb, wsTopBottom, "Ø£ÙØ¶Ù„ ÙˆØ£Ø³ÙˆØ£ 5");

  // Ø¯Ø¹Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ§Ù„Ø¬ÙˆØ§Ù„
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:"application/octet-stream"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ØªÙ‚ÙŠÙŠÙ…Ø§Øª_Ø§Ù„Ø´Ù‡Ø±.xlsx";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
function showErrors(){document.querySelectorAll('.item').forEach(i=>i.style.display=i.querySelector('.result').innerText==='âœ–ï¸'?'block':'none');}
function resetView(){document.querySelectorAll('.item').forEach(i=>{i.style.display='block';i.querySelector('.result').innerText='';});}
function deleteAllData(){if(confirm("Ù‡Ù„ Ø§Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")){localStorage.removeItem("evaluations");evaluations=[];alert("ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± âœ”ï¸");}}
function loadEmployeeNames(){const sel=document.getElementById("employeeSelect");sel.innerHTML="";employees.forEach(e=>sel.innerHTML+=`<option>${e}</option>`);}
function addEmployee(){const name=prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯:");if(name){employees.push(name);loadEmployeeNames();}}
function saveEmployees(){localStorage.setItem("employees",JSON.stringify(employees));alert("ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† âœ”ï¸");}

/* ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø© */
renderCriteria();
loadEmployeeNames();
</script>

</body>
</html>
